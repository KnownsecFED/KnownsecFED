{"version":3,"sources":["webpack:///path---2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an-32baff590fab4f9bba08.js","webpack:///./.cache/json/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an.json"],"names":["webpackJsonp","659","module","exports","data","site","siteMetadata","title","author","siteUrl","markdownRemark","id","html","fields","slug","frontmatter","date","catalog","allMarkdownRemark","edges","node","pathContext"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SAAkBC,MAAQC,MAAQC,cAAgBC,MAAA,oBAAAC,OAAA,cAAAC,QAAA,6BAAyFC,gBAAmBC,GAAA,yHAAAC,KAAA;AAAy1/BC,QAAknDC,KAAA,6DAAmEC,aAAgBR,MAAA,eAAAS,KAAA,aAAAC,QAAA,OAAAT,OAAA,SAA6EU,mBAAsBC,QAAUC,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,OAAea,MAAQP,QAAUC,KAAA,8CAAoDC,aAAgBR,MAAA,4BAAoCa,MAAQP,QAAUC,KAAA,4CAAkDC,aAAgBR,MAAA,iBAAyBa,MAAQP,QAAUC,KAAA,kCAAwCC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,mEAAyEC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,6EAAmFC,aAAgBR,MAAA,8BAAsCa,MAAQP,QAAUC,KAAA,yCAA+CC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,4CAAkDC,aAAgBR,MAAA,sBAA8Ba,MAAQP,QAAUC,KAAA,kCAAwCC,aAAgBR,MAAA,8BAAsCa,MAAQP,QAAUC,KAAA,kEAAwEC,aAAgBR,MAAA,oBAA4Ba,MAAQP,QAAUC,KAAA,kDAAwDC,aAAgBR,MAAA,mCAA2Ca,MAAQP,QAAUC,KAAA,+BAAqCC,aAAgBR,MAAA,4CAAoDa,MAAQP,QAAUC,KAAA,8EAAoFC,aAAgBR,MAAA,0BAAkCa,MAAQP,QAAUC,KAAA,wDAA8DC,aAAgBR,MAAA,oBAA4Ba,MAAQP,QAAUC,KAAA,6DAAmEC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,uDAA6DC,aAAgBR,MAAA,gBAAwBa,MAAQP,QAAUC,KAAA,6DAAmEC,aAAgBR,MAAA,6BAAqCa,MAAQP,QAAUC,KAAA,2CAAiDC,aAAgBR,MAAA,gBAAwBa,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,kBAA0Ba,MAAQP,QAAUC,KAAA,gCAAsCC,aAAgBR,MAAA,gBAAwBa,MAAQP,QAAUC,KAAA,kEAAwEC,aAAgBR,MAAA,0BAAkCa,MAAQP,QAAUC,KAAA,oEAA0EC,aAAgBR,MAAA,gCAAwCa,MAAQP,QAAUC,KAAA,qCAA2CC,aAAgBR,MAAA,gBAAwBa,MAAQP,QAAUC,KAAA,6CAAmDC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,uBAA6BC,aAAgBR,MAAA,wBAAgCa,MAAQP,QAAUC,KAAA,kEAAwEC,aAAgBR,MAAA,6BAAqCa,MAAQP,QAAUC,KAAA,oFAA0FC,aAAgBR,MAAA,iCAAyCa,MAAQP,QAAUC,KAAA,sFAA4FC,aAAgBR,MAAA,oCAA4Ca,MAAQP,QAAUC,KAAA,gFAAsFC,aAAgBR,MAAA,yBAAiCa,MAAQP,QAAUC,KAAA,4FAAkGC,aAAgBR,MAAA,8BAAsCa,MAAQP,QAAUC,KAAA,2EAAiFC,aAAgBR,MAAA,qCAA6Ca,MAAQP,QAAUC,KAAA,yCAA+CC,aAAgBR,MAAA,kBAA0Ba,MAAQP,QAAUC,KAAA,qDAA2DC,aAAgBR,MAAA,kBAA0Ba,MAAQP,QAAUC,KAAA,0DAAgEC,aAAgBR,MAAA,iCAAyCa,MAAQP,QAAUC,KAAA,mDAAyDC,aAAgBR,MAAA,gBAAwBa,MAAQP,QAAUC,KAAA,iDAAuDC,aAAgBR,MAAA,sBAA8Ba,MAAQP,QAAUC,KAAA,mFAAyFC,aAAgBR,MAAA,iCAAyCa,MAAQP,QAAUC,KAAA,kDAAwDC,aAAgBR,MAAA,eAAuBa,MAAQP,QAAUC,KAAA,kGAAwGC,aAAgBR,MAAA,sCAA8Ca,MAAQP,QAAUC,KAAA,4CAAkDC,aAAgBR,MAAA,qBAA6Ba,MAAQP,QAAUC,KAAA,yEAA+EC,aAAgBR,MAAA,6BAAqCa,MAAQP,QAAUC,KAAA,wEAA8EC,aAAgBR,MAAA,oBAA4Ba,MAAQP,QAAUC,KAAA,uEAA6EC,aAAgBR,MAAA,+BAAuCa,MAAQP,QAAUC,KAAA,qEAA2EC,aAAgBR,MAAA,qBAA6Ba,MAAQP,QAAUC,KAAA,sFAA4FC,aAAgBR,MAAA,2BAAmCa,MAAQP,QAAUC,KAAA,6BAAmCC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,4CAAkDC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,gCAAwCa,MAAQP,QAAUC,KAAA,mFAAyFC,aAAgBR,MAAA,qCAA6Ca,MAAQP,QAAUC,KAAA,+CAAqDC,aAAgBR,MAAA,oBAA4Ba,MAAQP,QAAUC,KAAA,kEAAwEC,aAAgBR,MAAA,iCAAyCa,MAAQP,QAAUC,KAAA,kDAAwDC,aAAgBR,MAAA,qCAA+Ca,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,wCAAgDa,MAAQP,QAAUC,KAAA,gFAAsFC,aAAgBR,MAAA,2BAAmCa,MAAQP,QAAUC,KAAA,gDAAsDC,aAAgBR,MAAA,0BAAkCa,MAAQP,QAAUC,KAAA,qIAA2IC,aAAgBR,MAAA,4CAAoDa,MAAQP,QAAUC,KAAA,wFAA8FC,aAAgBR,MAAA,yCAAiDa,MAAQP,QAAUC,KAAA,6CAAmDC,aAAgBR,MAAA,yBAAiCa,MAAQP,QAAUC,KAAA,0DAAgEC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,2CAAiDC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,2DAAiEC,aAAgBR,MAAA,qBAA6Ba,MAAQP,QAAUC,KAAA,uDAA6DC,aAAgBR,MAAA,+BAAuCa,MAAQP,QAAUC,KAAA,2DAAiEC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,+CAAqDC,aAAgBR,MAAA,kCAA0Ca,MAAQP,QAAUC,KAAA,sHAA4HC,aAAgBR,MAAA,+DAAuEa,MAAQP,QAAUC,KAAA,yCAA+CC,aAAgBR,MAAA,oCAA4Ca,MAAQP,QAAUC,KAAA,4CAAkDC,aAAgBR,MAAA,wBAAgCa,MAAQP,QAAUC,KAAA,sFAA4FC,aAAgBR,MAAA,yBAAiCa,MAAQP,QAAUC,KAAA,0CAAgDC,aAAgBR,MAAA,sBAA8Ba,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,iCAAuCC,aAAgBR,MAAA,4BAAoCa,MAAQP,QAAUC,KAAA,oCAA0CC,aAAgBR,MAAA,6BAAqCa,MAAQP,QAAUC,KAAA,4DAAkEC,aAAgBR,MAAA,sBAA8Ba,MAAQP,QAAUC,KAAA,gDAAsDC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,sDAA4DC,aAAgBR,MAAA,qBAA6Ba,MAAQP,QAAUC,KAAA,iDAAuDC,aAAgBR,MAAA,6BAAqCa,MAAQP,QAAUC,KAAA,wDAA8DC,aAAgBR,MAAA,uBAA+Ba,MAAQP,QAAUC,KAAA,gCAAsCC,aAAgBR,MAAA,wBAAgCa,MAAQP,QAAUC,KAAA,oDAA0DC,aAAgBR,MAAA,wBAAgCa,MAAQP,QAAUC,KAAA,sDAA4DC,aAAgBR,MAAA,uCAA+Ca,MAAQP,QAAUC,KAAA,mEAAyEC,aAAgBR,MAAA,yCAAiDa,MAAQP,QAAUC,KAAA,6BAAmCC,aAAgBR,MAAA,wCAAgDa,MAAQP,QAAUC,KAAA,8DAAoEC,aAAgBR,MAAA,yBAAiCa,MAAQP,QAAUC,KAAA,6CAAmDC,aAAgBR,MAAA,mBAA2Ba,MAAQP,QAAUC,KAAA,uBAA6BC,aAAgBR,MAAA,sBAA8Ba,MAAQP,QAAUC,KAAA,kDAAwDC,aAAgBR,MAAA,+BAAuCa,MAAQP,QAAUC,KAAA,0CAAgDC,aAAgBR,MAAA,yBAAgCc,aAAgBP,KAAA","file":"path---2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an-32baff590fab4f9bba08.js","sourcesContent":["webpackJsonp([38468654989701],{\n\n/***/ 659:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\"data\":{\"site\":{\"siteMetadata\":{\"title\":\"创宇前端 - 最酷开发者的技术分享\",\"author\":\"KnownsecFED\",\"siteUrl\":\"https://knownsec-fed.com\"}},\"markdownRemark\":{\"id\":\"/tmp/app/src/pages/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/index.md absPath of file >>> MarkdownRemark\",\"html\":\"<p>\\n  <a\\n    class=\\\"gatsby-resp-image-link\\\"\\n    href=\\\"/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-a770b.jpeg\\\"\\n    style=\\\"display: block\\\"\\n    target=\\\"_blank\\\"\\n    rel=\\\"noopener\\\"\\n  >\\n  \\n  <span\\n    class=\\\"gatsby-resp-image-wrapper\\\"\\n    style=\\\"position: relative; display: block; ; max-width: 1200px; margin-left: auto; margin-right: auto;\\\"\\n  >\\n    <span\\n      class=\\\"gatsby-resp-image-background-image\\\"\\n      style=\\\"padding-bottom: 52.48573757131214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQoz5VSa0/CQBDkr/tL/BFqjEKiEgmgRT8oCMhDFIJA3+/ea9zSVgoaE7eZzHZvOzd324qSEglXEPYE0h6jCCUFIFj+coBylGqKnorgDLafIJldIWodQZgvkLGJpHsMbvSyfiWIZQalcshdLa+nzZVC3owXGBq3GFsaXjcNDFc3mDgdjO0HQgcjU0PfaCERIQJuYWi1MaG1kdVBX2/S98utTiXdKY2lO0Z7dg5tVkXnowbtvYbHRY3yS9zPLoiraL2dwfENrN055afUk/U2pyf49KaFYOZQj+fomg0MrDv0zTZ6RhMDu02umhnIxfO6jpD5cBMdXb2OATlO8bS6hh7O9wWlb4O5azBPJ96AE3Nyw2UMrmIwYkacXrykU7G8zvO6VPxA0DQAxwGCgOADrgNlWbtJFkP9bdIoTbkQZIwjShI4nkf35G9zLgR+KP4Rqda3IOeczAWwyZXj2AjDIEe4RbpW5IfwyEQURftHLv6v8m7/RRpf3GsAKoymSTIAAAAASUVORK5CYII='); background-size: cover; display: block;\\\"\\n    >\\n      <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\"\\n        alt=\\\"一道事件循环题引发的血案\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-d6978.jpeg\\\"\\n        srcset=\\\"/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-527f0.jpeg 300w,\\n/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-9a7cd.jpeg 600w,\\n/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-d6978.jpeg 1200w,\\n/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-a770b.jpeg 1227w\\\"\\n        sizes=\\\"(max-width: 1200px) 100vw, 1200px\\\"\\n      />\\n    </span>\\n  </span>\\n  \\n  </a>\\n    </p>\\n<p>这次我们就不要那么多前戏，直奔主题，我们的龙门阵正式开始。</p>\\n<p>开局一道题，内容全靠吹。（此处应有滑稽）</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token comment\\\">// 文件名: index.js</span>\\n<span class=\\\"token comment\\\">// 我们尽量模拟所有的异步场景，包括 timers、Promise、nextTick等等</span>\\n<span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'timeout 1'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token number\\\">1</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\nprocess<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 1'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\nfs<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">readFile</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'./index.js'</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span>err<span class=\\\"token punctuation\\\">,</span> data<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">if</span><span class=\\\"token punctuation\\\">(</span>err<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token keyword\\\">return</span><span class=\\\"token punctuation\\\">;</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'I/O callback'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 2'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token function\\\">setImmediate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'immediate 1'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 3'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'timeout 2'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 4'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token number\\\">100</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>resolve<span class=\\\"token punctuation\\\">,</span> reject<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'promise run'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 5'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'promise then'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">setImmediate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'immediate 2'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span>res <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span>res<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p><strong>note:</strong> 上面的代码执行环境是 node v10.7.0，浏览器的事件循环和 node 还是有一点区别的，有兴趣的可以自己找资料看一看。</p>\\n<p>好了，上面的代码涉及到定时器、nextTick、Promise、setImmediate 和  I/O 操作。头皮有点小发麻哈，大家想好答案了么？检查一下吧！</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code>promise run\\nnextTick <span class=\\\"token number\\\">1</span>\\nnextTick <span class=\\\"token number\\\">5</span>\\npromise then\\ntimeout <span class=\\\"token number\\\">1</span>\\nimmediate <span class=\\\"token number\\\">1</span>\\nimmediate <span class=\\\"token number\\\">2</span>\\nnextTick <span class=\\\"token number\\\">3</span>\\nI<span class=\\\"token operator\\\">/</span>O callback\\nnextTick <span class=\\\"token number\\\">2</span>\\ntimeout <span class=\\\"token number\\\">2</span>\\nnextTick <span class=\\\"token number\\\">4</span>\\n</code></pre>\\n      </div>\\n<p>怎么样？跟自己想的一样么？不一样的话，就听我慢慢道来。</p>\\n<h2>event loop</h2>\\n<p>在 Node.js 中，event loop 是基于 libuv 的。通过查看 <a href=\\\"http://docs.libuv.org/en/v1.x/design.html\\\">libuv</a> 的文档可以发现整个 event loop 分为 6 个阶段：</p>\\n<ul>\\n<li>timers: 定时器相关任务，node 中我们关注的是它会执行 setTimeout() 和 setInterval() 中到期的回调</li>\\n<li>pending callbacks: 执行某些系统操作的回调</li>\\n<li>idle, prepare: 内部使用</li>\\n<li>poll: 执行 I/O callback，一定条件下会在这个阶段阻塞住</li>\\n<li>check: 执行 setImmediate 的回调</li>\\n<li>close callbacks: 如果 socket 或者 handle 关闭了，就会在这个阶段触发 close 事件，执行 close 事件的回调</li>\\n</ul>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-none\\\"><code>   ┌───────────────────────────┐\\n┌─>│           timers          │\\n│  └─────────────┬─────────────┘\\n│  ┌─────────────┴─────────────┐\\n│  │     pending callbacks     │\\n│  └─────────────┬─────────────┘\\n│  ┌─────────────┴─────────────┐\\n│  │       idle, prepare       │\\n│  └─────────────┬─────────────┘      ┌───────────────┐\\n│  ┌─────────────┴─────────────┐      │   incoming:   │\\n│  │           poll            │<─────┤  connections, │\\n│  └─────────────┬─────────────┘      │   data, etc.  │\\n│  ┌─────────────┴─────────────┐      └───────────────┘\\n│  │           check           │\\n│  └─────────────┬─────────────┘\\n│  ┌─────────────┴─────────────┐\\n└──┤      close callbacks      │\\n   └───────────────────────────┘</code></pre>\\n      </div>\\n<p>event loop 的代码在文件 <code>deps/uv/src/unix/core.c</code> 中。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>int uv_run(uv_loop_t* loop, uv_run_mode mode) {\\n  int timeout;\\n  int r;\\n  int ran_pending;\\n\\n  // 确定 event loop 是否继续\\n  r = uv__loop_alive(loop);\\n  if (!r)\\n    uv__update_time(loop);\\n\\n  while (r != 0 && loop->stop_flag == 0) {\\n    uv__update_time(loop); // 更新时间\\n    uv__run_timers(loop); // timers 阶段\\n    ran_pending = uv__run_pending(loop); // pending callbacks 阶段\\n    uv__run_idle(loop); // idle 阶段\\n    uv__run_prepare(loop); // prepare 阶段\\n\\n    timeout = 0;\\n    // 设置 poll 阶段的超时时间，有以下情况超时时间设为 0，此时 poll 不会阻塞\\n    // 1. stop_flag 不为 0\\n    // 2. 没有活跃的 handles 和 request\\n    // 3. idle、pending callback、close 阶段 handle 队列不为空\\n    // 否则的话会将超时时间设置成距离当前时间最近的 timer 的时间\\n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\\n      timeout = uv_backend_timeout(loop);\\n\\n    // poll 阶段\\n    uv__io_poll(loop, timeout);\\n    // check 阶段\\n    uv__run_check(loop);\\n    // close 阶段\\n    uv__run_closing_handles(loop);\\n\\n    if (mode == UV_RUN_ONCE) {\\n      uv__update_time(loop);\\n      uv__run_timers(loop);\\n    }\\n\\n    r = uv__loop_alive(loop);\\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\\n      break;\\n  }\\n\\n  if (loop->stop_flag != 0)\\n    loop->stop_flag = 0;\\n\\n  return r;\\n}</code></pre>\\n      </div>\\n<h2>注册加触发</h2>\\n<p>这一小节我们主要看看 Node 如何将我们写的定时器等等注册到 event loop 中去并执行的。</p>\\n<p>以 setTimeout 为例，首先我们进到了 <code>timers.js</code> 这个文件中，找到了 <code>setTimeout</code> 函数，我们主要关注这么两句：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> after<span class=\\\"token punctuation\\\">,</span> arg1<span class=\\\"token punctuation\\\">,</span> arg2<span class=\\\"token punctuation\\\">,</span> arg3<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n  <span class=\\\"token keyword\\\">const</span> timeout <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Timeout</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> after<span class=\\\"token punctuation\\\">,</span> args<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token boolean\\\">false</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">active</span><span class=\\\"token punctuation\\\">(</span>timeout<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n  <span class=\\\"token keyword\\\">return</span> timeout<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>我们看到它 new 了一个  Timeout 类，我们顺着这条线索找到了 Timeout 的构造函数：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">Timeout</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> after<span class=\\\"token punctuation\\\">,</span> args<span class=\\\"token punctuation\\\">,</span> isRepeat<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n  <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>_onTimeout <span class=\\\"token operator\\\">=</span> callback<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>我们主要关注这一句，Node 将回调挂载到了 <code>_onTimeout</code> 这个属性上。那么这个回调是在什么时候执行的呢？我们全局搜一下 <code>_onTimeout()</code>，我们可以发现是一个叫做 <code>ontimeout</code> 的方法执行了回调，好了，我们开始顺藤摸瓜，可以找到这么一条调用路径 <code>processTimers -> listOnTimeout -> tryOnTimeout -> ontimeout -> _onTimeout</code>。</p>\\n<p>最后的最后，我们在文件的头部发现了这么几行代码：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">{</span>\\n  getLibuvNow<span class=\\\"token punctuation\\\">,</span>\\n  setupTimers<span class=\\\"token punctuation\\\">,</span>\\n  scheduleTimer<span class=\\\"token punctuation\\\">,</span>\\n  toggleTimerRef<span class=\\\"token punctuation\\\">,</span>\\n  immediateInfo<span class=\\\"token punctuation\\\">,</span>\\n  toggleImmediateRef\\n<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">internalBinding</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'timers'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token function\\\">setupTimers</span><span class=\\\"token punctuation\\\">(</span>processImmediate<span class=\\\"token punctuation\\\">,</span> processTimers<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p>我们一看，<code>setupTimers</code> 是从 <code>internalBinding('timers')</code> 获取的，我们去看一下 <code>internalBinding</code> 就知道这就是 js 代码和内建模块关联的地方了。于是，我们顺着这条线索往下找，我们去 <code>src</code> 目录下去找叫 timers 的文件，果不其然，我们找到一个叫 <code>timers.cc</code> 的文件，同时，找到了一个叫 <code>SetupTimers</code> 的函数。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void SetupTimers(const FunctionCallbackInfo<Value>& args) {\\n  CHECK(args[0]->IsFunction());\\n  CHECK(args[1]->IsFunction());\\n  auto env = Environment::GetCurrent(args);\\n\\n  env->set_immediate_callback_function(args[0].As<Function>());\\n  env->set_timers_callback_function(args[1].As<Function>());\\n}</code></pre>\\n      </div>\\n<p>上面的 <code>args[1]</code> 就是我们传递的 <code>processTimers</code>，在这个函数中我们其实就完成了 <code>processTimers</code> 的注册，它成功的注册到了 node 中。</p>\\n<p>那是如何触发的回调呢？这里我们首先先看到 event loop 代码中的 timers 阶段执行的函数，然后跟进去：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void uv__run_timers(uv_loop_t* loop) {\\n  struct heap_node* heap_node;\\n  uv_timer_t* handle;\\n\\n  for (;;) {\\n    heap_node = heap_min(timer_heap(loop));\\n    if (heap_node == NULL)\\n      break;\\n\\n    handle = container_of(heap_node, uv_timer_t, heap_node);\\n    if (handle->timeout > loop->time)\\n      break;\\n\\n    uv_timer_stop(handle);\\n    uv_timer_again(handle);\\n    handle->timer_cb(handle);\\n  }\\n}</code></pre>\\n      </div>\\n<p>这段代码我们将我们的目光放在 <code>handle->timer_cb(handle)</code> 这一行，这个函数是在哪儿定义的呢？我们全局搜一下 <code>timer_cb</code> 发现 <code>uv_timer_start</code> 中有这么一行代码：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>handle->timer_cb = cb;</code></pre>\\n      </div>\\n<p>所以我们知道是调用了 <code>uv_timer_start</code> 将回调函数挂载到了 handle 上。那么 cb 又是什么呢？其实你沿着代码上去找就能发现其实 cb 就是 <code>timers_callback_function</code>，眼熟对么？这就是我们上面注册进来触发回调的函数 <code>processTimers</code>。</p>\\n<p>恍然大悟，原来是这么触发的回调，现在还有个问题，谁去调用的 <code>uv_timer_start</code> 呢？这个问题就简单了，我们通过源码可以知道是 <code>ScheduleTimer</code> 这个函数调用了，是不是感觉很熟悉，对，这个函数就是我们通过 <code>internalBinding</code> 引进来的 <code>scheduleTimer</code> 函数。</p>\\n<p>在这个地方就有点不一样了。现在最新的 tag 版本和 github 上 node 最新的代码是有区别的，在一次 pr 中，将 <code>timer_wrap.cc</code> 重构成了 <code>timers.cc</code>，并且移除了 <code>TimerWrap</code> 类，再说下面的区别之前，先补充一下 <code>timer</code> 对应的数据结构：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token comment\\\">// 这是在有 TimeWrap 的版本</span>\\n<span class=\\\"token comment\\\">// 对应的时间后面是一个 timer 链表</span>\\nrefedLists <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">:</span> TimeWrap<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">_list</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token number\\\">2000</span><span class=\\\"token punctuation\\\">:</span> TimeWrap<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">_list</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token comment\\\">// 这是 scheduleTimer 的版本</span>\\nrefedLists <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token number\\\">2000</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p>在 <code>TimeWrap</code> 的版本里，js 是通过调用实例化后的 <code>start()</code> 函数去调用了 <code>uv_timer_start</code>。</p>\\n<p>而 <code>scheduleTimer</code> 版本是注册定时器的时候通过比较哪个定时器是最近要执行的，从而将对应时间的 <code>timerList</code> 注册到 <code>uv_timer</code> 中去。</p>\\n<p>那么，为什么要这么改呢？是为了让定时器和 Immediate 拥有更相似的行为，也就是将单个 uv<em>timer</em>t handle 存在 Environment 上（Immediate 是有一个 ImmediateQueue，这也是个链表）。</p>\\n<p>这里就只说了一个 timer，其他的大家就自己去看看吧，顺着这个思路大家肯定会有所收获的。</p>\\n<h2>事件循环流程</h2>\\n<p>在加载 node 的时候，将 setTimeout、setInterval 的回调注册到 timerList，将 Promise.resolve 等 microTask 的回调注册到 microTasks，将 setImmediate 注册到 immediateQueue 中，将 process.nextTick 注册到 nextTickQueue 中。</p>\\n<p>当我们开始 event loop 的时候，首先进入 timers 阶段（我们只看跟我们上面说的相关的阶段），然后就判断 timerList 的时间是否到期了，如果到期了就执行，没有就下一个阶段（其实还有 nextTick，等下再说）。</p>\\n<p>接下来我们说 poll 阶段，在这个阶段，我们先计算需要在这个阶段阻塞轮询的时间（简单点就是下个 timer 的时间），然后等待监听的事件。</p>\\n<p>下个阶段是 check 阶段，对应的是 immediate，当有 immediateQueue 的时候就会跳过 poll 直接到 check 阶段执行 setImmediate 的回调。</p>\\n<p>那有同学就要问了，nextTick 和 microTasks 去哪儿了啊？别慌，听我慢慢道来。</p>\\n<h2>process.nextTick 和 microTasks</h2>\\n<p>现在我们有了刚刚找 timer 的经验，我们继续去看看 nextTick 是怎么执行的。</p>\\n<p>经过排查我们能找到一个叫 <code>_tickCallback</code> 的函数，它不断的从 nextTickQueue 中获取 nextTick 的回调执行。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">_tickCallback</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">let</span> tock<span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">do</span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">while</span> <span class=\\\"token punctuation\\\">(</span>tock <span class=\\\"token operator\\\">=</span> queue<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">shift</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token comment\\\">// ...</span>\\n        <span class=\\\"token keyword\\\">const</span> callback <span class=\\\"token operator\\\">=</span> tock<span class=\\\"token punctuation\\\">.</span>callback<span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>tock<span class=\\\"token punctuation\\\">.</span>args <span class=\\\"token operator\\\">===</span> undefined<span class=\\\"token punctuation\\\">)</span>\\n          <span class=\\\"token function\\\">callback</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">else</span>\\n          Reflect<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">apply</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> undefined<span class=\\\"token punctuation\\\">,</span> tock<span class=\\\"token punctuation\\\">.</span>args<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token function\\\">emitAfter</span><span class=\\\"token punctuation\\\">(</span>asyncId<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      tickInfo<span class=\\\"token punctuation\\\">[</span>kHasScheduled<span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">runMicrotasks</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">while</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>queue<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">isEmpty</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">||</span> <span class=\\\"token function\\\">emitPromiseRejectionWarnings</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    tickInfo<span class=\\\"token punctuation\\\">[</span>kHasPromiseRejections<span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>我们看到了什么？在将 nextTick 的回调执行完之后，它执行了 <code>runMicrotasks</code>。一切都真相大白了，microTasks 的执行时机是当执行完所有的 nextTick 的回调之后。那 nextTick 又是在什么时候执行的呢？</p>\\n<p>这就需要我们去找 C++ 的代码了，在 <code>bootstrapper.cc</code> 里找到了 <code>BOOTSTRAP_METHOD(_setupNextTick, SetupNextTick)</code>，所以我们就要去找 <code>SetupNextTick</code> 函数。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void SetupNextTick(const FunctionCallbackInfo<Value>& args) {\\n  Environment* env = Environment::GetCurrent(args);\\n  // ...\\n  env->set_tick_callback_function(args[0].As<Function>());\\n  // ...\\n}</code></pre>\\n      </div>\\n<p>我们关注这一句，是不是很熟啊，跟上面 timer 一样是吧，我们将 <code>__tickCallback</code> 注册到了 node，在 C++ 中通过 <code>tick_callback_function</code> 来调用这个函数。</p>\\n<p>我们通过查看源码可以发现是 <code>InternalCallbackScope</code> 这个类调用 <code>Close</code> 函数的时候就会触发 nextTixk 执行。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void InternalCallbackScope::Close() {\\n  if (closed_) return;\\n  closed_ = true;\\n  HandleScope handle_scope(env_->isolate());\\n  // ...\\n  if (!tick_info->has_scheduled()) {\\n    env_->isolate()->RunMicrotasks();\\n  }\\n  // ...\\n  if (!tick_info->has_scheduled() && !tick_info->has_promise_rejections()) {\\n    return;\\n  }\\n  // ...\\n  if (env_->tick_callback_function()->Call(process, 0, nullptr).IsEmpty()) {\\n    failed_ = true;\\n  }\\n}</code></pre>\\n      </div>\\n<p>可能有同学有疑问了，为啥在执行 nextTick 上面还有 <code>RunMicrotasks</code> 呢？其实这是对 event loop 的优化，假如没有 <code>process.nextTick</code> 就直接从 node 里面调用 <code>RunMicrotasks</code> 加快速度。</p>\\n<p>现在在 <code>node.cc</code> 里我们找到了调用 <code>Close</code> 的地方：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>MaybeLocal<Value> InternalMakeCallback(Environment* env,\\n                                       Local<Object> recv,\\n                                       const Local<Function> callback,\\n                                       int argc,\\n                                       Local<Value> argv[],\\n                                       async_context asyncContext) {\\n  CHECK(!recv.IsEmpty());\\n  InternalCallbackScope scope(env, recv, asyncContext);\\n\\n  scope.Close();\\n\\n  return ret;\\n}</code></pre>\\n      </div>\\n<p>而 <code>InternalMakeCallback()</code> 则是在 <code>async_wrap.cc</code> 的 <code>AsyncWrap::MakeCallback()</code> 中被调用。</p>\\n<p>找了半天，只找到了 setImmediate 注册时，注册函数执行回调运行了这个函数，没有找到 timer 的。之前因为使用的 TimeWrap，TimeWrap 继承了 AsyncWrap，在执行回调的时候调用了 <code>MakeCallback()</code>，问题是现在移除了 <code>TimeWrap</code>，那是怎么调用的呢？我们会到 js 代码，发现了这样的代码：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">{</span> _tickCallback<span class=\\\"token punctuation\\\">:</span> runNextTicks <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token operator\\\">=</span> process<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">processTimers</span><span class=\\\"token punctuation\\\">(</span>now<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">runNextTicks</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>一切都明了了，在移除了 <code>TimeWrap</code> 之后，将 <code>_tickCallback</code> 放到了这里执行，所以我们刚刚在 C++ 里找不到。</p>\\n<p>其实，每一个阶段执行完之后，都会去执行 <code>_tickCallback</code> ，只是方式可能有点不同。</p>\\n<h2>答案解析</h2>\\n<p>好了，刚刚了解了关于 event loop 的一些情况，我们再来看看文章开头的那段代码，我们一起来分析。</p>\\n<h3>第一步</h3>\\n<p>首先运行 Promise 里的代码，<strong>输出了 promise run</strong>，然后 promise.resolve 将 then 放入 microTasks。</p>\\n<h3>第二步</h3>\\n<p>这里要提到的一点是 nextTick 在注册之后，bootstrap 构建结束后运行<code>SetupNextTick</code>函数，这时候就会清空 nextTickQueue 和 MicroTasks，所以<strong>输出 nextTick 1、nextTick 5、promise then</strong>。</p>\\n<h3>第三步</h3>\\n<p>在 bootstrap 之后便进入了 event loop，第一个阶段 timers，这时 timeout 1 定时器时间到期，执行回调<strong>输出 timeout 1</strong>，timerList 没有其他定时器了，去清空 nextTickQueue 和 MicroTasks，没有任务，这时继续下阶段，这时候有 immediate，所以跳过 poll，进入 check，执行 immediate 回调，<strong>输出 immediate 1 和 immediate 2</strong>，并将 nextTick 3 推入 nextTickQueue，阶段完成 immediateQueue 没有需要处理的东西了，就去清空 nextTickQueue 和 MicroTasks <strong>输出 nextTick 3</strong>。</p>\\n<h3>第四步</h3>\\n<p>在这一轮，文件读取完成，并且 timers 没到期，进入 poll 阶段，超时时间设置为 timeout 2 的时间，执行回调<strong>输出 I/O callback</strong>，并且向 nextTickQueue 推入 nextTick 2。阻塞过程中没有其他的 I/O 事件，去清空 nextTickQueue 和 MicroTasks，<strong>输出 nextTick 2</strong>。</p>\\n<h3>第五步</h3>\\n<p>这时候又到了 timers 阶段，执行 timeout 2 的回调，<strong>输出 timeout 2</strong>，将 nextTick 4 推入 nextTickQueue，这时 timeList 已经没有定时器了，清空 nextTickQueue 和 MicroTasks <strong>输出 nextTick 4</strong>。</p>\\n<h2>总结</h2>\\n<p>不知道大家懂了没有，整个过程其实还比较粗糙，在学习过程中也看了不少的源码分析，但是 node 发展很快，很多分析已经过时了，源码改变了不少，但是对于理清思路还是很有作用的。</p>\\n<p>各位看官如果觉得还行、OK、有点用，欢迎来我 <a href=\\\"https://github.com/balancelove/readingNotes\\\">GitHub</a> 给个小星星，我会很舒服的，哈哈。</p>\",\"fields\":{\"slug\":\"/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/\"},\"frontmatter\":{\"title\":\"一道事件循环题引发的血案\",\"date\":\"2018-09-13\",\"catalog\":\"技术杂谈\",\"author\":\"小烜同学\"}},\"allMarkdownRemark\":{\"edges\":[{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-ru-he-xie-yi-ge-gao-bi-ge-readme/howToWrite/\"},\"frontmatter\":{\"title\":\"\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-22-yi-reactnative-yu-ios-jiao-hu/\"},\"frontmatter\":{\"title\":\"【译】React Native与ios交互\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-11-yi-ni-er-duo-li-you-tiao-yu/\"},\"frontmatter\":{\"title\":\"【译】你耳朵里有条鱼\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-07-dapp-dev-practice/\"},\"frontmatter\":{\"title\":\"区块链上编程：DApp 开发实践\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-05-ni-ting-shuo-guo-yuan-sheng-html-zu-jian-ma/\"},\"frontmatter\":{\"title\":\"你听说过原生 HTML 组件吗？\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-28-yong-huo-zhuo-de-cnn-jin-hang-yan-zheng-ma-shi-bie/\"},\"frontmatter\":{\"title\":\"用“活着的”CNN进行验证码识别\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-27-yi-chao-shi-yong-7-ge-you-xiu-de-ui-jiao-hu-dong-hua-ji-qiao/\"},\"frontmatter\":{\"title\":\"【译】超实用！7 个优秀的 UI 交互动画技巧\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-guan-yu-http2-de-yan-jiu/\"},\"frontmatter\":{\"title\":\"关于 HTTP2 的研究\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-yi-android-lu-jing-dong-hua/\"},\"frontmatter\":{\"title\":\"【译】Android 路径动画\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25- heretic-judger-1/\"},\"frontmatter\":{\"title\":\"异端审判器！一个泛用型文本聚类模型的实现（1）\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-wo-men-ying-gai-zuo-xie-li-suo-neng-ji-de-you-hua/\"},\"frontmatter\":{\"title\":\"我们应该做些力所能及的优化\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-twenty-to-fifty-years-programming/\"},\"frontmatter\":{\"title\":\"【译】有哪些事情是编程 20 到 50 多年后才知道的？\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-24-mongodb-shi-wu/\"},\"frontmatter\":{\"title\":\"认识 MongoDB 4.0 的新特性——事务（Transactions）\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-19-yi-yu-yong-hu-lian-xi-zai-wang-ye-she-ji-zhong-rong-ru-you-mo/\"},\"frontmatter\":{\"title\":\"【译】与用户联系：在网页设计中融入幽默\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-19-yi-ru-he-she-ji-geng-hao-de-shu-ju-biao/\"},\"frontmatter\":{\"title\":\"【译】如何设计更好的数据表\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/\"},\"frontmatter\":{\"title\":\"一道事件循环题引发的血案\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-12-qian-duan-gong-cheng-hua-jiao-shou-jia/\"},\"frontmatter\":{\"title\":\"前端工程化：脚手架\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-12-qian-tan-vue-zhong-computed-shi-xian-yuan-li/\"},\"frontmatter\":{\"title\":\"浅谈 Vue 中 computed 实现原理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-11-http-de-qian-shi-jin-sheng/\"},\"frontmatter\":{\"title\":\"Http的前世今生\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-31-jian-shu-da-shu-ju-shi-shi-chu-li-kuang-jia/\"},\"frontmatter\":{\"title\":\"简述大数据实时处理框架\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-22-shen-ru-promise/\"},\"frontmatter\":{\"title\":\"深入Promise\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-13-tcp-lian-jie-ji-chang-jian-gong-ji-shou-fa-fen-xi/\"},\"frontmatter\":{\"title\":\"要点梳理：TCP连接及常见攻击手法分析\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-13-ran-bing-luan-bf-ke-pu-bf-jie-shi-qi-de-js-shi-xian/\"},\"frontmatter\":{\"title\":\"然并卵：BF 科普 & BF 解释器的 JS 实现\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-10-dapp-kai-fa-jian-jie/\"},\"frontmatter\":{\"title\":\"DApp 开发简介\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-09-shi-lian-zhi-shi-performance/\"},\"frontmatter\":{\"title\":\"试炼之石-Performance\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-09-prolog/\"},\"frontmatter\":{\"title\":\"那迷人的被遗忘的语言：Prolog\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-08-qiao-qiao-xian-qi-webassembly-de-shen-mi-mian-sha/\"},\"frontmatter\":{\"title\":\"悄悄掀起 WebAssembly 的神秘面纱\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-16-fan-yi-2018-nian-12-zhong-yi-dong-duan-yong-hu-ti-yan-she-ji-qu-shi/\"},\"frontmatter\":{\"title\":\"【翻译】2018 年 12 种移动端用户体验设计趋势\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-08-fan-yi-mei-ge-uiux-she-ji-shi-du-xu-yao-zhi-dao-de-xin-li-xue-yuan-li/\"},\"frontmatter\":{\"title\":\"【翻译】每个 UI / UX 设计师都需要知道的心理学原理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-07-fan-yi-yan-fa-ren-yuan-de-sheng-chan-li-shi-fou-ke-yi-liang-hua/\"},\"frontmatter\":{\"title\":\"【翻译】研发人员的生产力是否可以量化\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-01-fan-yi-jie-he-tu-xing-he-yu-yin-jie-mian-ti-gong-geng-hao-de-yong-hu-ti-yan/\"},\"frontmatter\":{\"title\":\"【翻译】结合图形和语音界面，提供更好的用户体验\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-31-fan-yi-http1-dao-http2-de-yan-bian-ru-he-gai-bian-liao-web/\"},\"frontmatter\":{\"title\":\"【译】HTTP1 到 HTTP 2 的演变如何改变了 web\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-28-shui-dong-liao-wo-de-dom/\"},\"frontmatter\":{\"title\":\"谁动了我的 DOM？！\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-27-fan-yi-wei-kai-yuan-ruan-jian-she-ji/\"},\"frontmatter\":{\"title\":\"【翻译】为开源软件设计\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-27-fan-yi-nodejstwofactor-shen-fen-ren-zheng/\"},\"frontmatter\":{\"title\":\"【译】node.js Two-Factor 身份认证\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-react-server-side-render-with-hapi/\"},\"frontmatter\":{\"title\":\"服务端渲染和静态化\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-ru-he-xie-yi-ge-gao-bi-ge-readme/\"},\"frontmatter\":{\"title\":\"如何写一个高逼格 README\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-quan-zhan-gong-cheng-shi-zhi-lu-reactnative-zhi-sao-miao-er-wei-ma/\"},\"frontmatter\":{\"title\":\"全栈工程师之路-React Native之扫描二维码\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-22-wu-xian-wang-luo-ling-lei-xiu-tan/\"},\"frontmatter\":{\"title\":\"无线网络另类嗅探\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-19-fan-yi-shi-yong-de-ui-dong-hua-ji-qiao-gai-jin-ui-wei-jiao-hu-de-shi-yong-jian-yi/\"},\"frontmatter\":{\"title\":\"【翻译】实用的 UI 动画技巧——改进 UI 微交互的实用建议\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-19-reactref-zhi-bei-jiao-cheng/\"},\"frontmatter\":{\"title\":\"React ref 指北教程\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-18-fan-yi-how-to-prevent-your-node.js-process-from-crashing/\"},\"frontmatter\":{\"title\":\"【翻译】 如何使你的 Node 应用免于崩溃\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-17-yi-zhong-qian-hou-duan-fen-li-de-kua-yu-kai-fa-fang-shi/\"},\"frontmatter\":{\"title\":\"一种方便的跨域开发解决方案\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-16-yuan-chuang-ji-yu-babylonjs-shi-xian-3d-da-ji-xiao-guo/\"},\"frontmatter\":{\"title\":\"基于 Babylon.js 实现 3D 打击效果\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-13-fan-yi-ru-he-chuang-jian-jiao-hu-you-hao-de-biao-dan/\"},\"frontmatter\":{\"title\":\"【译】如何创建交互友好的表单\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-12-fan-yi-rang-wo-men-cong-ling-kai-shi-bian-bian-xie-yi-ge-web-fu-wu-qi/\"},\"frontmatter\":{\"title\":\"【译】让我们从零开始编写一个web服务器\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-11-bikeshedding/\"},\"frontmatter\":{\"title\":\"由屎色自行车棚引发的思考\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-11-xin-shou-shi-jiao-de-docker/\"},\"frontmatter\":{\"title\":\"新手视角的 Docker\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-07-fan-yi-ji-yu-cypress-ce-shi-react-ying-yong/\"},\"frontmatter\":{\"title\":\"【译】基于 Cypress 测试 React 应用\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-05-fan-yi-ru-he-zhao-dao-wan-mei-de-se-cai-da-pei-jie-shao-colorclaim/\"},\"frontmatter\":{\"title\":\"【译】如何找到完美的色彩搭配 - 介绍 ColorClaim\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-05-ru-he-shi-yong-mac-po-jie-wifi/\"},\"frontmatter\":{\"title\":\"如何使用Mac破解Wifi\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-05-yi-ge-chrome-kuo-zhan-jiu-zhe-yang-dan-sheng-liao/\"},\"frontmatter\":{\"title\":\"程序员偷懒指南——用chrome插件实现前端资讯推送\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-01-wei-xian-de-targetblank-yu-opener/\"},\"frontmatter\":{\"title\":\"危险的 target=\\\"_blank\\\" 与 “opener”\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-28-activerecord-he-datamappers-mo-shi-jian-jie/\"},\"frontmatter\":{\"title\":\"Active Record 和 Data Mappers 模式简介\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-26-bu-jin-jin-shi-piao-liang-tu-xiang-ru-he-qu-dong-yong-hu-ti-yan/\"},\"frontmatter\":{\"title\":\"【译】不仅仅是漂亮：图像如何驱动用户体验\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-23-css3-clip-path-yong-fa-jie-shao/\"},\"frontmatter\":{\"title\":\"CSS3 clip-path 用法介绍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-23-du-shu-bi-ji-ke-shi-hua-shi-yi-zhong-yi-shu-bu-zhi-shi-mei-xin-xi-tu-biao-she-ji-yuan-li-yu-jing-dian-an-li-xu-zhang/\"},\"frontmatter\":{\"title\":\"读书笔记：可视化是一种艺术 -《不只是美：信息图表设计原理与经典案例》序章\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-23-mei-ge-node-ying-yong-ke-neng-cun-zai-de-timing-attack-an-quan-lou-dong/\"},\"frontmatter\":{\"title\":\"每个 node 应用可能存在的 timing-attack 安全漏洞\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-09-zan-lai-liao-liao-vuecompile/\"},\"frontmatter\":{\"title\":\"咱来聊聊 Vue - compile\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-05-ji-yi-ci-jian-dan-de-csrf-gong-ji-shi-yan/\"},\"frontmatter\":{\"title\":\"记一次简单的 CSRF 攻击实验\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-04-fan-yi-reactscope-jie-shao/\"},\"frontmatter\":{\"title\":\"【译】React Scope介绍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-03-fan-yi-liu-ge-xuan-ze-ui-yan-se-de-ji-qiao/\"},\"frontmatter\":{\"title\":\"【译】六个选择UI颜色的技巧\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-03-huo-yong-git-apply-he-ru-patch-bu-ding/\"},\"frontmatter\":{\"title\":\"活用 git apply 合入 patch 补丁\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-03-wo-de-di-yi-ge-node-ming-ling-hang-gong-ju/\"},\"frontmatter\":{\"title\":\"我的第一个 Node 命令行工具\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-01-fan-yi-react-xin-de-contextapi/\"},\"frontmatter\":{\"title\":\"【译】React ⚛️  新的 Context API\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-29-kuai-su-da-jian-ni-de-github-page-ge-ren-bo-ke-ji-yu-createreactapp-de-dan-ye-mian-ying-yong-shi-jian/\"},\"frontmatter\":{\"title\":\"快速搭建你的 github pages 个人博客 —— 基于 Create-React-App 的单页面应用实践\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-28-redux-promise-middleware/\"},\"frontmatter\":{\"title\":\"一个插件让你在 Redux 中写 promise 事半功倍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-28-fan-yi-react-zu-jian-mo-shi/\"},\"frontmatter\":{\"title\":\"【译】React 组件设计模式基础\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-28-fan-yi-bu-yao-rang-yong-hu-zai-chan-pin-ti-yan-shang-shou-dao-cuo-zhe/\"},\"frontmatter\":{\"title\":\"【译】不要让用户在产品体验上受到挫折\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-27-javascript-mo-huan-dai-li/\"},\"frontmatter\":{\"title\":\"JavaScript 魔幻代理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-22-web-qian-duan-jian-dan-ding-yue-de-shi-xian/\"},\"frontmatter\":{\"title\":\"Web前端简单订阅的实现\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-21-how-django-works/\"},\"frontmatter\":{\"title\":\"从请求到响应 django 都做了哪些处理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-21-electron-with-react/\"},\"frontmatter\":{\"title\":\"React+Electron搭建一个桌面应用\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-20-fan-yi-ui-she-ji-zhong-de-ge-shi-ta-yuan-ze/\"},\"frontmatter\":{\"title\":\"【译】UI 设计中的格式塔原则\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-19-xia-yi-dai-tong-xin-xie-yi-quic/\"},\"frontmatter\":{\"title\":\"下一代通信协议：QUIC\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-19-fan-yi-shi-yong-css-zhui-zong-yong-hu/\"},\"frontmatter\":{\"title\":\"【译】使用 CSS 追踪用户\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-14-antd-yuan-ma-jie-du-notification/\"},\"frontmatter\":{\"title\":\"antd 源码解读 notification\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-14-ui-zhong-de-pai-ban-chu-xue-zhe-zhi-nan/\"},\"frontmatter\":{\"title\":\"【译】UI 中的排版：初学者指南\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-14-learn-koa-intro/\"},\"frontmatter\":{\"title\":\"koa包教包会(一)——白话koa\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-13-zi-ji-dong-shou-xie-yi-ge-simplevue/\"},\"frontmatter\":{\"title\":\"自己动手写一个 SimpleVue\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-12-translation-React-Animations-in-Depth/\"},\"frontmatter\":{\"title\":\"【译】React Web 动画的 5 种创建方式，每一种都不简单\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-10-ru-he-kuo-zhan-create-react-app-de-webpack-pei-zhi/\"},\"frontmatter\":{\"title\":\"如何扩展 Create React App 的 Webpack 配置\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-08-mapbox-gl-js/\"},\"frontmatter\":{\"title\":\"3D GIS 应用开发 —— 基于 Mapbox GL 的实践总结\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-07-the-importance-of-visual-appeal-in-web-design/\"},\"frontmatter\":{\"title\":\"【译】视觉吸引力在网页设计中的重要性\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-06-react-higher-order-component/\"},\"frontmatter\":{\"title\":\"React 高阶组件介绍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-05-to-vim/\"},\"frontmatter\":{\"title\":\"如何让 vim 成为我们的神器\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-05-d3-js-v3-data-driven-and-d3-force/\"},\"frontmatter\":{\"title\":\"D3.js 数据驱动 和 force 力学图讲解\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-05-create-a-redux-middleware/\"},\"frontmatter\":{\"title\":\"如何编写一个 Redux 中间件\"}}}]}},\"pathContext\":{\"slug\":\"/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/\"}}\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an-32baff590fab4f9bba08.js","module.exports = {\"data\":{\"site\":{\"siteMetadata\":{\"title\":\"创宇前端 - 最酷开发者的技术分享\",\"author\":\"KnownsecFED\",\"siteUrl\":\"https://knownsec-fed.com\"}},\"markdownRemark\":{\"id\":\"/tmp/app/src/pages/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/index.md absPath of file >>> MarkdownRemark\",\"html\":\"<p>\\n  <a\\n    class=\\\"gatsby-resp-image-link\\\"\\n    href=\\\"/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-a770b.jpeg\\\"\\n    style=\\\"display: block\\\"\\n    target=\\\"_blank\\\"\\n    rel=\\\"noopener\\\"\\n  >\\n  \\n  <span\\n    class=\\\"gatsby-resp-image-wrapper\\\"\\n    style=\\\"position: relative; display: block; ; max-width: 1200px; margin-left: auto; margin-right: auto;\\\"\\n  >\\n    <span\\n      class=\\\"gatsby-resp-image-background-image\\\"\\n      style=\\\"padding-bottom: 52.48573757131214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQoz5VSa0/CQBDkr/tL/BFqjEKiEgmgRT8oCMhDFIJA3+/ea9zSVgoaE7eZzHZvOzd324qSEglXEPYE0h6jCCUFIFj+coBylGqKnorgDLafIJldIWodQZgvkLGJpHsMbvSyfiWIZQalcshdLa+nzZVC3owXGBq3GFsaXjcNDFc3mDgdjO0HQgcjU0PfaCERIQJuYWi1MaG1kdVBX2/S98utTiXdKY2lO0Z7dg5tVkXnowbtvYbHRY3yS9zPLoiraL2dwfENrN055afUk/U2pyf49KaFYOZQj+fomg0MrDv0zTZ6RhMDu02umhnIxfO6jpD5cBMdXb2OATlO8bS6hh7O9wWlb4O5azBPJ96AE3Nyw2UMrmIwYkacXrykU7G8zvO6VPxA0DQAxwGCgOADrgNlWbtJFkP9bdIoTbkQZIwjShI4nkf35G9zLgR+KP4Rqda3IOeczAWwyZXj2AjDIEe4RbpW5IfwyEQURftHLv6v8m7/RRpf3GsAKoymSTIAAAAASUVORK5CYII='); background-size: cover; display: block;\\\"\\n    >\\n      <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\"\\n        alt=\\\"一道事件循环题引发的血案\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-d6978.jpeg\\\"\\n        srcset=\\\"/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-527f0.jpeg 300w,\\n/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-9a7cd.jpeg 600w,\\n/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-d6978.jpeg 1200w,\\n/static/header-3a59c624e6ff95a7e8c5a23c979f5abe-a770b.jpeg 1227w\\\"\\n        sizes=\\\"(max-width: 1200px) 100vw, 1200px\\\"\\n      />\\n    </span>\\n  </span>\\n  \\n  </a>\\n    </p>\\n<p>这次我们就不要那么多前戏，直奔主题，我们的龙门阵正式开始。</p>\\n<p>开局一道题，内容全靠吹。（此处应有滑稽）</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token comment\\\">// 文件名: index.js</span>\\n<span class=\\\"token comment\\\">// 我们尽量模拟所有的异步场景，包括 timers、Promise、nextTick等等</span>\\n<span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'timeout 1'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token number\\\">1</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\nprocess<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 1'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\nfs<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">readFile</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'./index.js'</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span>err<span class=\\\"token punctuation\\\">,</span> data<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">if</span><span class=\\\"token punctuation\\\">(</span>err<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token keyword\\\">return</span><span class=\\\"token punctuation\\\">;</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'I/O callback'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 2'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token function\\\">setImmediate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'immediate 1'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 3'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'timeout 2'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 4'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token number\\\">100</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>resolve<span class=\\\"token punctuation\\\">,</span> reject<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'promise run'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  process<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">nextTick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'nextTick 5'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'promise then'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">setImmediate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'immediate 2'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span>res <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  console<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span>res<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p><strong>note:</strong> 上面的代码执行环境是 node v10.7.0，浏览器的事件循环和 node 还是有一点区别的，有兴趣的可以自己找资料看一看。</p>\\n<p>好了，上面的代码涉及到定时器、nextTick、Promise、setImmediate 和  I/O 操作。头皮有点小发麻哈，大家想好答案了么？检查一下吧！</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code>promise run\\nnextTick <span class=\\\"token number\\\">1</span>\\nnextTick <span class=\\\"token number\\\">5</span>\\npromise then\\ntimeout <span class=\\\"token number\\\">1</span>\\nimmediate <span class=\\\"token number\\\">1</span>\\nimmediate <span class=\\\"token number\\\">2</span>\\nnextTick <span class=\\\"token number\\\">3</span>\\nI<span class=\\\"token operator\\\">/</span>O callback\\nnextTick <span class=\\\"token number\\\">2</span>\\ntimeout <span class=\\\"token number\\\">2</span>\\nnextTick <span class=\\\"token number\\\">4</span>\\n</code></pre>\\n      </div>\\n<p>怎么样？跟自己想的一样么？不一样的话，就听我慢慢道来。</p>\\n<h2>event loop</h2>\\n<p>在 Node.js 中，event loop 是基于 libuv 的。通过查看 <a href=\\\"http://docs.libuv.org/en/v1.x/design.html\\\">libuv</a> 的文档可以发现整个 event loop 分为 6 个阶段：</p>\\n<ul>\\n<li>timers: 定时器相关任务，node 中我们关注的是它会执行 setTimeout() 和 setInterval() 中到期的回调</li>\\n<li>pending callbacks: 执行某些系统操作的回调</li>\\n<li>idle, prepare: 内部使用</li>\\n<li>poll: 执行 I/O callback，一定条件下会在这个阶段阻塞住</li>\\n<li>check: 执行 setImmediate 的回调</li>\\n<li>close callbacks: 如果 socket 或者 handle 关闭了，就会在这个阶段触发 close 事件，执行 close 事件的回调</li>\\n</ul>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-none\\\"><code>   ┌───────────────────────────┐\\n┌─>│           timers          │\\n│  └─────────────┬─────────────┘\\n│  ┌─────────────┴─────────────┐\\n│  │     pending callbacks     │\\n│  └─────────────┬─────────────┘\\n│  ┌─────────────┴─────────────┐\\n│  │       idle, prepare       │\\n│  └─────────────┬─────────────┘      ┌───────────────┐\\n│  ┌─────────────┴─────────────┐      │   incoming:   │\\n│  │           poll            │<─────┤  connections, │\\n│  └─────────────┬─────────────┘      │   data, etc.  │\\n│  ┌─────────────┴─────────────┐      └───────────────┘\\n│  │           check           │\\n│  └─────────────┬─────────────┘\\n│  ┌─────────────┴─────────────┐\\n└──┤      close callbacks      │\\n   └───────────────────────────┘</code></pre>\\n      </div>\\n<p>event loop 的代码在文件 <code>deps/uv/src/unix/core.c</code> 中。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>int uv_run(uv_loop_t* loop, uv_run_mode mode) {\\n  int timeout;\\n  int r;\\n  int ran_pending;\\n\\n  // 确定 event loop 是否继续\\n  r = uv__loop_alive(loop);\\n  if (!r)\\n    uv__update_time(loop);\\n\\n  while (r != 0 && loop->stop_flag == 0) {\\n    uv__update_time(loop); // 更新时间\\n    uv__run_timers(loop); // timers 阶段\\n    ran_pending = uv__run_pending(loop); // pending callbacks 阶段\\n    uv__run_idle(loop); // idle 阶段\\n    uv__run_prepare(loop); // prepare 阶段\\n\\n    timeout = 0;\\n    // 设置 poll 阶段的超时时间，有以下情况超时时间设为 0，此时 poll 不会阻塞\\n    // 1. stop_flag 不为 0\\n    // 2. 没有活跃的 handles 和 request\\n    // 3. idle、pending callback、close 阶段 handle 队列不为空\\n    // 否则的话会将超时时间设置成距离当前时间最近的 timer 的时间\\n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\\n      timeout = uv_backend_timeout(loop);\\n\\n    // poll 阶段\\n    uv__io_poll(loop, timeout);\\n    // check 阶段\\n    uv__run_check(loop);\\n    // close 阶段\\n    uv__run_closing_handles(loop);\\n\\n    if (mode == UV_RUN_ONCE) {\\n      uv__update_time(loop);\\n      uv__run_timers(loop);\\n    }\\n\\n    r = uv__loop_alive(loop);\\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\\n      break;\\n  }\\n\\n  if (loop->stop_flag != 0)\\n    loop->stop_flag = 0;\\n\\n  return r;\\n}</code></pre>\\n      </div>\\n<h2>注册加触发</h2>\\n<p>这一小节我们主要看看 Node 如何将我们写的定时器等等注册到 event loop 中去并执行的。</p>\\n<p>以 setTimeout 为例，首先我们进到了 <code>timers.js</code> 这个文件中，找到了 <code>setTimeout</code> 函数，我们主要关注这么两句：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> after<span class=\\\"token punctuation\\\">,</span> arg1<span class=\\\"token punctuation\\\">,</span> arg2<span class=\\\"token punctuation\\\">,</span> arg3<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n  <span class=\\\"token keyword\\\">const</span> timeout <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Timeout</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> after<span class=\\\"token punctuation\\\">,</span> args<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token boolean\\\">false</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">active</span><span class=\\\"token punctuation\\\">(</span>timeout<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n  <span class=\\\"token keyword\\\">return</span> timeout<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>我们看到它 new 了一个  Timeout 类，我们顺着这条线索找到了 Timeout 的构造函数：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">Timeout</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> after<span class=\\\"token punctuation\\\">,</span> args<span class=\\\"token punctuation\\\">,</span> isRepeat<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n  <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>_onTimeout <span class=\\\"token operator\\\">=</span> callback<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>我们主要关注这一句，Node 将回调挂载到了 <code>_onTimeout</code> 这个属性上。那么这个回调是在什么时候执行的呢？我们全局搜一下 <code>_onTimeout()</code>，我们可以发现是一个叫做 <code>ontimeout</code> 的方法执行了回调，好了，我们开始顺藤摸瓜，可以找到这么一条调用路径 <code>processTimers -> listOnTimeout -> tryOnTimeout -> ontimeout -> _onTimeout</code>。</p>\\n<p>最后的最后，我们在文件的头部发现了这么几行代码：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">{</span>\\n  getLibuvNow<span class=\\\"token punctuation\\\">,</span>\\n  setupTimers<span class=\\\"token punctuation\\\">,</span>\\n  scheduleTimer<span class=\\\"token punctuation\\\">,</span>\\n  toggleTimerRef<span class=\\\"token punctuation\\\">,</span>\\n  immediateInfo<span class=\\\"token punctuation\\\">,</span>\\n  toggleImmediateRef\\n<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">internalBinding</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'timers'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token function\\\">setupTimers</span><span class=\\\"token punctuation\\\">(</span>processImmediate<span class=\\\"token punctuation\\\">,</span> processTimers<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p>我们一看，<code>setupTimers</code> 是从 <code>internalBinding('timers')</code> 获取的，我们去看一下 <code>internalBinding</code> 就知道这就是 js 代码和内建模块关联的地方了。于是，我们顺着这条线索往下找，我们去 <code>src</code> 目录下去找叫 timers 的文件，果不其然，我们找到一个叫 <code>timers.cc</code> 的文件，同时，找到了一个叫 <code>SetupTimers</code> 的函数。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void SetupTimers(const FunctionCallbackInfo<Value>& args) {\\n  CHECK(args[0]->IsFunction());\\n  CHECK(args[1]->IsFunction());\\n  auto env = Environment::GetCurrent(args);\\n\\n  env->set_immediate_callback_function(args[0].As<Function>());\\n  env->set_timers_callback_function(args[1].As<Function>());\\n}</code></pre>\\n      </div>\\n<p>上面的 <code>args[1]</code> 就是我们传递的 <code>processTimers</code>，在这个函数中我们其实就完成了 <code>processTimers</code> 的注册，它成功的注册到了 node 中。</p>\\n<p>那是如何触发的回调呢？这里我们首先先看到 event loop 代码中的 timers 阶段执行的函数，然后跟进去：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void uv__run_timers(uv_loop_t* loop) {\\n  struct heap_node* heap_node;\\n  uv_timer_t* handle;\\n\\n  for (;;) {\\n    heap_node = heap_min(timer_heap(loop));\\n    if (heap_node == NULL)\\n      break;\\n\\n    handle = container_of(heap_node, uv_timer_t, heap_node);\\n    if (handle->timeout > loop->time)\\n      break;\\n\\n    uv_timer_stop(handle);\\n    uv_timer_again(handle);\\n    handle->timer_cb(handle);\\n  }\\n}</code></pre>\\n      </div>\\n<p>这段代码我们将我们的目光放在 <code>handle->timer_cb(handle)</code> 这一行，这个函数是在哪儿定义的呢？我们全局搜一下 <code>timer_cb</code> 发现 <code>uv_timer_start</code> 中有这么一行代码：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>handle->timer_cb = cb;</code></pre>\\n      </div>\\n<p>所以我们知道是调用了 <code>uv_timer_start</code> 将回调函数挂载到了 handle 上。那么 cb 又是什么呢？其实你沿着代码上去找就能发现其实 cb 就是 <code>timers_callback_function</code>，眼熟对么？这就是我们上面注册进来触发回调的函数 <code>processTimers</code>。</p>\\n<p>恍然大悟，原来是这么触发的回调，现在还有个问题，谁去调用的 <code>uv_timer_start</code> 呢？这个问题就简单了，我们通过源码可以知道是 <code>ScheduleTimer</code> 这个函数调用了，是不是感觉很熟悉，对，这个函数就是我们通过 <code>internalBinding</code> 引进来的 <code>scheduleTimer</code> 函数。</p>\\n<p>在这个地方就有点不一样了。现在最新的 tag 版本和 github 上 node 最新的代码是有区别的，在一次 pr 中，将 <code>timer_wrap.cc</code> 重构成了 <code>timers.cc</code>，并且移除了 <code>TimerWrap</code> 类，再说下面的区别之前，先补充一下 <code>timer</code> 对应的数据结构：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token comment\\\">// 这是在有 TimeWrap 的版本</span>\\n<span class=\\\"token comment\\\">// 对应的时间后面是一个 timer 链表</span>\\nrefedLists <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">:</span> TimeWrap<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">_list</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token number\\\">2000</span><span class=\\\"token punctuation\\\">:</span> TimeWrap<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">_list</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token comment\\\">// 这是 scheduleTimer 的版本</span>\\nrefedLists <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token number\\\">2000</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">TimersList</span><span class=\\\"token punctuation\\\">(</span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">></span>item<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p>在 <code>TimeWrap</code> 的版本里，js 是通过调用实例化后的 <code>start()</code> 函数去调用了 <code>uv_timer_start</code>。</p>\\n<p>而 <code>scheduleTimer</code> 版本是注册定时器的时候通过比较哪个定时器是最近要执行的，从而将对应时间的 <code>timerList</code> 注册到 <code>uv_timer</code> 中去。</p>\\n<p>那么，为什么要这么改呢？是为了让定时器和 Immediate 拥有更相似的行为，也就是将单个 uv<em>timer</em>t handle 存在 Environment 上（Immediate 是有一个 ImmediateQueue，这也是个链表）。</p>\\n<p>这里就只说了一个 timer，其他的大家就自己去看看吧，顺着这个思路大家肯定会有所收获的。</p>\\n<h2>事件循环流程</h2>\\n<p>在加载 node 的时候，将 setTimeout、setInterval 的回调注册到 timerList，将 Promise.resolve 等 microTask 的回调注册到 microTasks，将 setImmediate 注册到 immediateQueue 中，将 process.nextTick 注册到 nextTickQueue 中。</p>\\n<p>当我们开始 event loop 的时候，首先进入 timers 阶段（我们只看跟我们上面说的相关的阶段），然后就判断 timerList 的时间是否到期了，如果到期了就执行，没有就下一个阶段（其实还有 nextTick，等下再说）。</p>\\n<p>接下来我们说 poll 阶段，在这个阶段，我们先计算需要在这个阶段阻塞轮询的时间（简单点就是下个 timer 的时间），然后等待监听的事件。</p>\\n<p>下个阶段是 check 阶段，对应的是 immediate，当有 immediateQueue 的时候就会跳过 poll 直接到 check 阶段执行 setImmediate 的回调。</p>\\n<p>那有同学就要问了，nextTick 和 microTasks 去哪儿了啊？别慌，听我慢慢道来。</p>\\n<h2>process.nextTick 和 microTasks</h2>\\n<p>现在我们有了刚刚找 timer 的经验，我们继续去看看 nextTick 是怎么执行的。</p>\\n<p>经过排查我们能找到一个叫 <code>_tickCallback</code> 的函数，它不断的从 nextTickQueue 中获取 nextTick 的回调执行。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">_tickCallback</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">let</span> tock<span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">do</span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">while</span> <span class=\\\"token punctuation\\\">(</span>tock <span class=\\\"token operator\\\">=</span> queue<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">shift</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token comment\\\">// ...</span>\\n        <span class=\\\"token keyword\\\">const</span> callback <span class=\\\"token operator\\\">=</span> tock<span class=\\\"token punctuation\\\">.</span>callback<span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>tock<span class=\\\"token punctuation\\\">.</span>args <span class=\\\"token operator\\\">===</span> undefined<span class=\\\"token punctuation\\\">)</span>\\n          <span class=\\\"token function\\\">callback</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">else</span>\\n          Reflect<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">apply</span><span class=\\\"token punctuation\\\">(</span>callback<span class=\\\"token punctuation\\\">,</span> undefined<span class=\\\"token punctuation\\\">,</span> tock<span class=\\\"token punctuation\\\">.</span>args<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token function\\\">emitAfter</span><span class=\\\"token punctuation\\\">(</span>asyncId<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      tickInfo<span class=\\\"token punctuation\\\">[</span>kHasScheduled<span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">runMicrotasks</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">while</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>queue<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">isEmpty</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">||</span> <span class=\\\"token function\\\">emitPromiseRejectionWarnings</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    tickInfo<span class=\\\"token punctuation\\\">[</span>kHasPromiseRejections<span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>我们看到了什么？在将 nextTick 的回调执行完之后，它执行了 <code>runMicrotasks</code>。一切都真相大白了，microTasks 的执行时机是当执行完所有的 nextTick 的回调之后。那 nextTick 又是在什么时候执行的呢？</p>\\n<p>这就需要我们去找 C++ 的代码了，在 <code>bootstrapper.cc</code> 里找到了 <code>BOOTSTRAP_METHOD(_setupNextTick, SetupNextTick)</code>，所以我们就要去找 <code>SetupNextTick</code> 函数。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void SetupNextTick(const FunctionCallbackInfo<Value>& args) {\\n  Environment* env = Environment::GetCurrent(args);\\n  // ...\\n  env->set_tick_callback_function(args[0].As<Function>());\\n  // ...\\n}</code></pre>\\n      </div>\\n<p>我们关注这一句，是不是很熟啊，跟上面 timer 一样是吧，我们将 <code>__tickCallback</code> 注册到了 node，在 C++ 中通过 <code>tick_callback_function</code> 来调用这个函数。</p>\\n<p>我们通过查看源码可以发现是 <code>InternalCallbackScope</code> 这个类调用 <code>Close</code> 函数的时候就会触发 nextTixk 执行。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>void InternalCallbackScope::Close() {\\n  if (closed_) return;\\n  closed_ = true;\\n  HandleScope handle_scope(env_->isolate());\\n  // ...\\n  if (!tick_info->has_scheduled()) {\\n    env_->isolate()->RunMicrotasks();\\n  }\\n  // ...\\n  if (!tick_info->has_scheduled() && !tick_info->has_promise_rejections()) {\\n    return;\\n  }\\n  // ...\\n  if (env_->tick_callback_function()->Call(process, 0, nullptr).IsEmpty()) {\\n    failed_ = true;\\n  }\\n}</code></pre>\\n      </div>\\n<p>可能有同学有疑问了，为啥在执行 nextTick 上面还有 <code>RunMicrotasks</code> 呢？其实这是对 event loop 的优化，假如没有 <code>process.nextTick</code> 就直接从 node 里面调用 <code>RunMicrotasks</code> 加快速度。</p>\\n<p>现在在 <code>node.cc</code> 里我们找到了调用 <code>Close</code> 的地方：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-c++\\\"><code>MaybeLocal<Value> InternalMakeCallback(Environment* env,\\n                                       Local<Object> recv,\\n                                       const Local<Function> callback,\\n                                       int argc,\\n                                       Local<Value> argv[],\\n                                       async_context asyncContext) {\\n  CHECK(!recv.IsEmpty());\\n  InternalCallbackScope scope(env, recv, asyncContext);\\n\\n  scope.Close();\\n\\n  return ret;\\n}</code></pre>\\n      </div>\\n<p>而 <code>InternalMakeCallback()</code> 则是在 <code>async_wrap.cc</code> 的 <code>AsyncWrap::MakeCallback()</code> 中被调用。</p>\\n<p>找了半天，只找到了 setImmediate 注册时，注册函数执行回调运行了这个函数，没有找到 timer 的。之前因为使用的 TimeWrap，TimeWrap 继承了 AsyncWrap，在执行回调的时候调用了 <code>MakeCallback()</code>，问题是现在移除了 <code>TimeWrap</code>，那是怎么调用的呢？我们会到 js 代码，发现了这样的代码：</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code><span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">{</span> _tickCallback<span class=\\\"token punctuation\\\">:</span> runNextTicks <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token operator\\\">=</span> process<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">processTimers</span><span class=\\\"token punctuation\\\">(</span>now<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">runNextTicks</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>一切都明了了，在移除了 <code>TimeWrap</code> 之后，将 <code>_tickCallback</code> 放到了这里执行，所以我们刚刚在 C++ 里找不到。</p>\\n<p>其实，每一个阶段执行完之后，都会去执行 <code>_tickCallback</code> ，只是方式可能有点不同。</p>\\n<h2>答案解析</h2>\\n<p>好了，刚刚了解了关于 event loop 的一些情况，我们再来看看文章开头的那段代码，我们一起来分析。</p>\\n<h3>第一步</h3>\\n<p>首先运行 Promise 里的代码，<strong>输出了 promise run</strong>，然后 promise.resolve 将 then 放入 microTasks。</p>\\n<h3>第二步</h3>\\n<p>这里要提到的一点是 nextTick 在注册之后，bootstrap 构建结束后运行<code>SetupNextTick</code>函数，这时候就会清空 nextTickQueue 和 MicroTasks，所以<strong>输出 nextTick 1、nextTick 5、promise then</strong>。</p>\\n<h3>第三步</h3>\\n<p>在 bootstrap 之后便进入了 event loop，第一个阶段 timers，这时 timeout 1 定时器时间到期，执行回调<strong>输出 timeout 1</strong>，timerList 没有其他定时器了，去清空 nextTickQueue 和 MicroTasks，没有任务，这时继续下阶段，这时候有 immediate，所以跳过 poll，进入 check，执行 immediate 回调，<strong>输出 immediate 1 和 immediate 2</strong>，并将 nextTick 3 推入 nextTickQueue，阶段完成 immediateQueue 没有需要处理的东西了，就去清空 nextTickQueue 和 MicroTasks <strong>输出 nextTick 3</strong>。</p>\\n<h3>第四步</h3>\\n<p>在这一轮，文件读取完成，并且 timers 没到期，进入 poll 阶段，超时时间设置为 timeout 2 的时间，执行回调<strong>输出 I/O callback</strong>，并且向 nextTickQueue 推入 nextTick 2。阻塞过程中没有其他的 I/O 事件，去清空 nextTickQueue 和 MicroTasks，<strong>输出 nextTick 2</strong>。</p>\\n<h3>第五步</h3>\\n<p>这时候又到了 timers 阶段，执行 timeout 2 的回调，<strong>输出 timeout 2</strong>，将 nextTick 4 推入 nextTickQueue，这时 timeList 已经没有定时器了，清空 nextTickQueue 和 MicroTasks <strong>输出 nextTick 4</strong>。</p>\\n<h2>总结</h2>\\n<p>不知道大家懂了没有，整个过程其实还比较粗糙，在学习过程中也看了不少的源码分析，但是 node 发展很快，很多分析已经过时了，源码改变了不少，但是对于理清思路还是很有作用的。</p>\\n<p>各位看官如果觉得还行、OK、有点用，欢迎来我 <a href=\\\"https://github.com/balancelove/readingNotes\\\">GitHub</a> 给个小星星，我会很舒服的，哈哈。</p>\",\"fields\":{\"slug\":\"/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/\"},\"frontmatter\":{\"title\":\"一道事件循环题引发的血案\",\"date\":\"2018-09-13\",\"catalog\":\"技术杂谈\",\"author\":\"小烜同学\"}},\"allMarkdownRemark\":{\"edges\":[{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-ru-he-xie-yi-ge-gao-bi-ge-readme/howToWrite/\"},\"frontmatter\":{\"title\":\"\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-22-yi-reactnative-yu-ios-jiao-hu/\"},\"frontmatter\":{\"title\":\"【译】React Native与ios交互\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-11-yi-ni-er-duo-li-you-tiao-yu/\"},\"frontmatter\":{\"title\":\"【译】你耳朵里有条鱼\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-07-dapp-dev-practice/\"},\"frontmatter\":{\"title\":\"区块链上编程：DApp 开发实践\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-10-05-ni-ting-shuo-guo-yuan-sheng-html-zu-jian-ma/\"},\"frontmatter\":{\"title\":\"你听说过原生 HTML 组件吗？\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-28-yong-huo-zhuo-de-cnn-jin-hang-yan-zheng-ma-shi-bie/\"},\"frontmatter\":{\"title\":\"用“活着的”CNN进行验证码识别\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-27-yi-chao-shi-yong-7-ge-you-xiu-de-ui-jiao-hu-dong-hua-ji-qiao/\"},\"frontmatter\":{\"title\":\"【译】超实用！7 个优秀的 UI 交互动画技巧\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-guan-yu-http2-de-yan-jiu/\"},\"frontmatter\":{\"title\":\"关于 HTTP2 的研究\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-yi-android-lu-jing-dong-hua/\"},\"frontmatter\":{\"title\":\"【译】Android 路径动画\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25- heretic-judger-1/\"},\"frontmatter\":{\"title\":\"异端审判器！一个泛用型文本聚类模型的实现（1）\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-wo-men-ying-gai-zuo-xie-li-suo-neng-ji-de-you-hua/\"},\"frontmatter\":{\"title\":\"我们应该做些力所能及的优化\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-25-twenty-to-fifty-years-programming/\"},\"frontmatter\":{\"title\":\"【译】有哪些事情是编程 20 到 50 多年后才知道的？\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-24-mongodb-shi-wu/\"},\"frontmatter\":{\"title\":\"认识 MongoDB 4.0 的新特性——事务（Transactions）\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-19-yi-yu-yong-hu-lian-xi-zai-wang-ye-she-ji-zhong-rong-ru-you-mo/\"},\"frontmatter\":{\"title\":\"【译】与用户联系：在网页设计中融入幽默\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-19-yi-ru-he-she-ji-geng-hao-de-shu-ju-biao/\"},\"frontmatter\":{\"title\":\"【译】如何设计更好的数据表\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/\"},\"frontmatter\":{\"title\":\"一道事件循环题引发的血案\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-12-qian-duan-gong-cheng-hua-jiao-shou-jia/\"},\"frontmatter\":{\"title\":\"前端工程化：脚手架\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-12-qian-tan-vue-zhong-computed-shi-xian-yuan-li/\"},\"frontmatter\":{\"title\":\"浅谈 Vue 中 computed 实现原理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-09-11-http-de-qian-shi-jin-sheng/\"},\"frontmatter\":{\"title\":\"Http的前世今生\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-31-jian-shu-da-shu-ju-shi-shi-chu-li-kuang-jia/\"},\"frontmatter\":{\"title\":\"简述大数据实时处理框架\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-22-shen-ru-promise/\"},\"frontmatter\":{\"title\":\"深入Promise\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-13-tcp-lian-jie-ji-chang-jian-gong-ji-shou-fa-fen-xi/\"},\"frontmatter\":{\"title\":\"要点梳理：TCP连接及常见攻击手法分析\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-13-ran-bing-luan-bf-ke-pu-bf-jie-shi-qi-de-js-shi-xian/\"},\"frontmatter\":{\"title\":\"然并卵：BF 科普 & BF 解释器的 JS 实现\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-10-dapp-kai-fa-jian-jie/\"},\"frontmatter\":{\"title\":\"DApp 开发简介\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-09-shi-lian-zhi-shi-performance/\"},\"frontmatter\":{\"title\":\"试炼之石-Performance\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-09-prolog/\"},\"frontmatter\":{\"title\":\"那迷人的被遗忘的语言：Prolog\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-08-08-qiao-qiao-xian-qi-webassembly-de-shen-mi-mian-sha/\"},\"frontmatter\":{\"title\":\"悄悄掀起 WebAssembly 的神秘面纱\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-16-fan-yi-2018-nian-12-zhong-yi-dong-duan-yong-hu-ti-yan-she-ji-qu-shi/\"},\"frontmatter\":{\"title\":\"【翻译】2018 年 12 种移动端用户体验设计趋势\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-08-fan-yi-mei-ge-uiux-she-ji-shi-du-xu-yao-zhi-dao-de-xin-li-xue-yuan-li/\"},\"frontmatter\":{\"title\":\"【翻译】每个 UI / UX 设计师都需要知道的心理学原理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-07-fan-yi-yan-fa-ren-yuan-de-sheng-chan-li-shi-fou-ke-yi-liang-hua/\"},\"frontmatter\":{\"title\":\"【翻译】研发人员的生产力是否可以量化\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-04-01-fan-yi-jie-he-tu-xing-he-yu-yin-jie-mian-ti-gong-geng-hao-de-yong-hu-ti-yan/\"},\"frontmatter\":{\"title\":\"【翻译】结合图形和语音界面，提供更好的用户体验\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-31-fan-yi-http1-dao-http2-de-yan-bian-ru-he-gai-bian-liao-web/\"},\"frontmatter\":{\"title\":\"【译】HTTP1 到 HTTP 2 的演变如何改变了 web\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-28-shui-dong-liao-wo-de-dom/\"},\"frontmatter\":{\"title\":\"谁动了我的 DOM？！\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-27-fan-yi-wei-kai-yuan-ruan-jian-she-ji/\"},\"frontmatter\":{\"title\":\"【翻译】为开源软件设计\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-27-fan-yi-nodejstwofactor-shen-fen-ren-zheng/\"},\"frontmatter\":{\"title\":\"【译】node.js Two-Factor 身份认证\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-react-server-side-render-with-hapi/\"},\"frontmatter\":{\"title\":\"服务端渲染和静态化\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-ru-he-xie-yi-ge-gao-bi-ge-readme/\"},\"frontmatter\":{\"title\":\"如何写一个高逼格 README\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-25-quan-zhan-gong-cheng-shi-zhi-lu-reactnative-zhi-sao-miao-er-wei-ma/\"},\"frontmatter\":{\"title\":\"全栈工程师之路-React Native之扫描二维码\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-22-wu-xian-wang-luo-ling-lei-xiu-tan/\"},\"frontmatter\":{\"title\":\"无线网络另类嗅探\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-19-fan-yi-shi-yong-de-ui-dong-hua-ji-qiao-gai-jin-ui-wei-jiao-hu-de-shi-yong-jian-yi/\"},\"frontmatter\":{\"title\":\"【翻译】实用的 UI 动画技巧——改进 UI 微交互的实用建议\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-19-reactref-zhi-bei-jiao-cheng/\"},\"frontmatter\":{\"title\":\"React ref 指北教程\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-18-fan-yi-how-to-prevent-your-node.js-process-from-crashing/\"},\"frontmatter\":{\"title\":\"【翻译】 如何使你的 Node 应用免于崩溃\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-17-yi-zhong-qian-hou-duan-fen-li-de-kua-yu-kai-fa-fang-shi/\"},\"frontmatter\":{\"title\":\"一种方便的跨域开发解决方案\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-16-yuan-chuang-ji-yu-babylonjs-shi-xian-3d-da-ji-xiao-guo/\"},\"frontmatter\":{\"title\":\"基于 Babylon.js 实现 3D 打击效果\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-13-fan-yi-ru-he-chuang-jian-jiao-hu-you-hao-de-biao-dan/\"},\"frontmatter\":{\"title\":\"【译】如何创建交互友好的表单\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-12-fan-yi-rang-wo-men-cong-ling-kai-shi-bian-bian-xie-yi-ge-web-fu-wu-qi/\"},\"frontmatter\":{\"title\":\"【译】让我们从零开始编写一个web服务器\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-11-bikeshedding/\"},\"frontmatter\":{\"title\":\"由屎色自行车棚引发的思考\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-11-xin-shou-shi-jiao-de-docker/\"},\"frontmatter\":{\"title\":\"新手视角的 Docker\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-07-fan-yi-ji-yu-cypress-ce-shi-react-ying-yong/\"},\"frontmatter\":{\"title\":\"【译】基于 Cypress 测试 React 应用\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-05-fan-yi-ru-he-zhao-dao-wan-mei-de-se-cai-da-pei-jie-shao-colorclaim/\"},\"frontmatter\":{\"title\":\"【译】如何找到完美的色彩搭配 - 介绍 ColorClaim\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-05-ru-he-shi-yong-mac-po-jie-wifi/\"},\"frontmatter\":{\"title\":\"如何使用Mac破解Wifi\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-05-yi-ge-chrome-kuo-zhan-jiu-zhe-yang-dan-sheng-liao/\"},\"frontmatter\":{\"title\":\"程序员偷懒指南——用chrome插件实现前端资讯推送\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-03-01-wei-xian-de-targetblank-yu-opener/\"},\"frontmatter\":{\"title\":\"危险的 target=\\\"_blank\\\" 与 “opener”\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-28-activerecord-he-datamappers-mo-shi-jian-jie/\"},\"frontmatter\":{\"title\":\"Active Record 和 Data Mappers 模式简介\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-26-bu-jin-jin-shi-piao-liang-tu-xiang-ru-he-qu-dong-yong-hu-ti-yan/\"},\"frontmatter\":{\"title\":\"【译】不仅仅是漂亮：图像如何驱动用户体验\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-23-css3-clip-path-yong-fa-jie-shao/\"},\"frontmatter\":{\"title\":\"CSS3 clip-path 用法介绍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-23-du-shu-bi-ji-ke-shi-hua-shi-yi-zhong-yi-shu-bu-zhi-shi-mei-xin-xi-tu-biao-she-ji-yuan-li-yu-jing-dian-an-li-xu-zhang/\"},\"frontmatter\":{\"title\":\"读书笔记：可视化是一种艺术 -《不只是美：信息图表设计原理与经典案例》序章\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-23-mei-ge-node-ying-yong-ke-neng-cun-zai-de-timing-attack-an-quan-lou-dong/\"},\"frontmatter\":{\"title\":\"每个 node 应用可能存在的 timing-attack 安全漏洞\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-09-zan-lai-liao-liao-vuecompile/\"},\"frontmatter\":{\"title\":\"咱来聊聊 Vue - compile\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-05-ji-yi-ci-jian-dan-de-csrf-gong-ji-shi-yan/\"},\"frontmatter\":{\"title\":\"记一次简单的 CSRF 攻击实验\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-04-fan-yi-reactscope-jie-shao/\"},\"frontmatter\":{\"title\":\"【译】React Scope介绍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-03-fan-yi-liu-ge-xuan-ze-ui-yan-se-de-ji-qiao/\"},\"frontmatter\":{\"title\":\"【译】六个选择UI颜色的技巧\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-03-huo-yong-git-apply-he-ru-patch-bu-ding/\"},\"frontmatter\":{\"title\":\"活用 git apply 合入 patch 补丁\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-03-wo-de-di-yi-ge-node-ming-ling-hang-gong-ju/\"},\"frontmatter\":{\"title\":\"我的第一个 Node 命令行工具\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-02-01-fan-yi-react-xin-de-contextapi/\"},\"frontmatter\":{\"title\":\"【译】React ⚛️  新的 Context API\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-29-kuai-su-da-jian-ni-de-github-page-ge-ren-bo-ke-ji-yu-createreactapp-de-dan-ye-mian-ying-yong-shi-jian/\"},\"frontmatter\":{\"title\":\"快速搭建你的 github pages 个人博客 —— 基于 Create-React-App 的单页面应用实践\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-28-redux-promise-middleware/\"},\"frontmatter\":{\"title\":\"一个插件让你在 Redux 中写 promise 事半功倍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-28-fan-yi-react-zu-jian-mo-shi/\"},\"frontmatter\":{\"title\":\"【译】React 组件设计模式基础\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-28-fan-yi-bu-yao-rang-yong-hu-zai-chan-pin-ti-yan-shang-shou-dao-cuo-zhe/\"},\"frontmatter\":{\"title\":\"【译】不要让用户在产品体验上受到挫折\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-27-javascript-mo-huan-dai-li/\"},\"frontmatter\":{\"title\":\"JavaScript 魔幻代理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-22-web-qian-duan-jian-dan-ding-yue-de-shi-xian/\"},\"frontmatter\":{\"title\":\"Web前端简单订阅的实现\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-21-how-django-works/\"},\"frontmatter\":{\"title\":\"从请求到响应 django 都做了哪些处理\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-21-electron-with-react/\"},\"frontmatter\":{\"title\":\"React+Electron搭建一个桌面应用\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-20-fan-yi-ui-she-ji-zhong-de-ge-shi-ta-yuan-ze/\"},\"frontmatter\":{\"title\":\"【译】UI 设计中的格式塔原则\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-19-xia-yi-dai-tong-xin-xie-yi-quic/\"},\"frontmatter\":{\"title\":\"下一代通信协议：QUIC\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-19-fan-yi-shi-yong-css-zhui-zong-yong-hu/\"},\"frontmatter\":{\"title\":\"【译】使用 CSS 追踪用户\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-14-antd-yuan-ma-jie-du-notification/\"},\"frontmatter\":{\"title\":\"antd 源码解读 notification\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-14-ui-zhong-de-pai-ban-chu-xue-zhe-zhi-nan/\"},\"frontmatter\":{\"title\":\"【译】UI 中的排版：初学者指南\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-14-learn-koa-intro/\"},\"frontmatter\":{\"title\":\"koa包教包会(一)——白话koa\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-13-zi-ji-dong-shou-xie-yi-ge-simplevue/\"},\"frontmatter\":{\"title\":\"自己动手写一个 SimpleVue\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-12-translation-React-Animations-in-Depth/\"},\"frontmatter\":{\"title\":\"【译】React Web 动画的 5 种创建方式，每一种都不简单\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-10-ru-he-kuo-zhan-create-react-app-de-webpack-pei-zhi/\"},\"frontmatter\":{\"title\":\"如何扩展 Create React App 的 Webpack 配置\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-08-mapbox-gl-js/\"},\"frontmatter\":{\"title\":\"3D GIS 应用开发 —— 基于 Mapbox GL 的实践总结\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-07-the-importance-of-visual-appeal-in-web-design/\"},\"frontmatter\":{\"title\":\"【译】视觉吸引力在网页设计中的重要性\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-06-react-higher-order-component/\"},\"frontmatter\":{\"title\":\"React 高阶组件介绍\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-05-to-vim/\"},\"frontmatter\":{\"title\":\"如何让 vim 成为我们的神器\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-05-d3-js-v3-data-driven-and-d3-force/\"},\"frontmatter\":{\"title\":\"D3.js 数据驱动 和 force 力学图讲解\"}}},{\"node\":{\"fields\":{\"slug\":\"/2018-01-05-create-a-redux-middleware/\"},\"frontmatter\":{\"title\":\"如何编写一个 Redux 中间件\"}}}]}},\"pathContext\":{\"slug\":\"/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an/\"}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/2018-09-13-yi-dao-shi-jian-xun-huan-ti-yin-fa-de-xie-an.json\n// module id = 659\n// module chunks = 38468654989701"],"sourceRoot":""}